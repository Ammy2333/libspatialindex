name: Docs

on:
  pull_request:
    branches:
    - '*'
  release:
    types:
      - published
jobs:
  docs:
    name: Docs

    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    container: osgeo/proj-docs

    steps:
    - uses: actions/checkout@v2
    - name: Print versions
      shell: bash -l {0}
      run: |
          python3 --version
          sphinx-build --version
    - name: Lint .rst files
      shell: bash -l {0}
      run: |
        if find . -name '*.rst' | xargs grep -P '\t'; then echo 'Tabs are bad, please use four spaces in .rst files.'; false; fi
      working-directory: ./docs
    - name: HTML
      shell: bash -l {0}
      run: |
        make html
      working-directory: ./docs
    - name: Doxygen
      shell: bash -l {0}
      run: |
        make doxygen
      working-directory: ./docs
    - name: PDF
      shell: bash -l {0}
      run: |
        make latexpdf
      working-directory: ./docs


    - name: Checkout Docs
      uses: actions/checkout@v2
      with:
        repository: libspatialindex/libspatialindex.github.com
        path: website
        clean: false

    - name: Push docs
      uses: actions/checkout@v2
      shell: bash -l {0}
      run: |
        git config --global user.email "proj4bot@proj4.bot"
        git config --global user.name "PDAL Doc Bot"
        cp -r ./docs/build/html/* ./website
        cp -r ./docs/build/latex/libspatialindex.pdf ./website
        cp -r ./docs/doxygen/html/* ./website/doxygen/
        cd website
        ls
        git add -A
        git commit -m "Update with https://github.com/libspatialindex/libspatialindex/commit/$GITHUB_SHA_SHORT"
        git push

